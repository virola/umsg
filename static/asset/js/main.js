/*! message.94uv.com 2014-09-22 */
var loading={show:function(a,b){if(this.main=$(".loading"),!this.main.size()){var c=$(b);if(!c.size())return;this.main=$("<div>加载中...</div>").addClass("loading").insertAfter(c)}a&&this.main.text(a),this.main.show()},hide:function(){$(".loading").hide()},error:function(a,b,c){$(".loading").hide();var d=$(a);d.size()&&(c||(c="加载失败，请点击重试!"),b=b||function(){},this.mainErr=$("<div>"+c+"</div>").addClass("loading-error").insertAfter(d),this.mainErr.on("click",b))},complete:function(a){$(".loading").text(a||"加载完毕").show()}};$(function(){$(".btn-form-send").on("click",function(){$("form").submit()}),$(".popup-close").on("click",function(){var a=$(this).closest(".wrap-popup");a.hide()});var a=$(".c-item:eq(0)"),b=$(".tab-item:eq(0)"),c=$("#pop-userlist");$("#open-user-list").on("click",function(){c.children("div").css({minHeight:$(window).height()}),c.show(),a.load(b.attr("data-url"),function(){})}),$(".tab-menu").on("click",".tab-item",function(){var a=$(this),b=a.closest(".tab-menu"),c=b.next(".tab-content"),d=$($(a).attr("href"));return d.size()&&(c.children(".c-item").hide(),d.show(),b.find(".current").removeClass("current"),a.addClass("current"),a.hasClass("select")||d.load(a.attr("data-url"))),!1});var d=$(".tab-item:eq(1)"),e=$(".c-item:eq(1)");$(".select-list").on("change",function(){var a=$(this),b=a.next(".select-selected"),c=a.val();b.text(a.find("option[value="+c+"]").text()),e.load(d.attr("data-url"),function(){})});var f=$("#msg-username");$(".user-wrap").on("click",".list-item",function(){var a=$(this).find("dt").text();f.val(a),c.hide(),f.focus()});{var g=$("#chat-sendmsg-form"),h=$("#chat-sendmsg-box").find(".txt");$(".sendmsg-go")}h.on("keydown",function(){}).on("focusin",function(){}),g.on("submit",function(){var a=g.attr("action"),b=$.trim(h.val());return b?($.ajax({type:"post",url:a,data:{content:b},dataType:"json",success:function(a){a&&0===a.status&&window.location.reload()}}),!1):!1}),scrollModule.init()});var scrollModule=function(){function a(){f=new IScroll("#page-chat",{probeType:2,mouseWheel:!0,scrollbars:!0,fadeScrollbars:!0,momentum:!0,shrinkScrollbars:"scale",click:!0});var a;f.on("scroll",function(){var c=this;return e||d?!1:(c.y>0&&loading.show("下拉加载历史消息"),a&&clearTimeout(a),void(a=setTimeout(function(){c.y>=5&&!d&&(h++,b(h))},200)))}),f.on("scrollEnd",function(){if(e||d)return!1;var a=this.y;5>a&&loading.hide()})}function b(a){if(d)return!1;var b=i+"&page="+a;d=1,loading.show("加载中...",g),$.ajax({url:b,dataType:"json",success:function(a){setTimeout(function(){d=0,0===a.status&&(c(a.data.list||[]),setTimeout(function(){f.refresh()},0),loading.hide(),a.data.loadend&&(e=1,loading.complete("已全部显示")))},1e3)},failure:function(){d=0}})}function c(a){var b=[];$.each(a,function(a,c){var d="guest-talk";c.issend&&(d="me-talk");var e='<li class="clear"><time class="date-talk">'+c.dateline+'</time><section class="'+d+'"><a class="avatar-talk" href="#"><img class="avator-round" src="'+c.avator+'"></a><div class="content-talk"><p>'+c.content+"</p></div></section></li>";b[a]=e}),$(b.join("")).insertBefore(g.children("li:first"))}var d,e,f,g=$("#talk-msg-list"),h=1,i=g.attr("data-url");return{init:function(){g.size()&&a()}}}();