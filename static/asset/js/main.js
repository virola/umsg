/*! zhitiao.94uv.com 2014-11-11 */
var loading={show:function(a,b){if(this.main=$(".loading"),!this.main.size()){var c=$(b);if(!c.size())return;this.main=$("<div>加载中...</div>").addClass("loading").insertAfter(c)}a&&this.main.text(a),this.main.show()},hide:function(){$(".loading").hide()},error:function(a,b,c){$(".loading").hide();var d=$(a);d.size()&&(c||(c="加载失败，请点击重试!"),b=b||function(){},this.mainErr=$("<div>"+c+"</div>").addClass("loading-error").insertAfter(d),this.mainErr.on("click",b))},complete:function(a){$(".loading").text(a||"加载完毕").show()}},util=function(){var a={};return a.parseJSON=function(a){a=a||"{}";try{return new Function("return ("+a+")")()}catch(b){return{}}},a}(),pageParams=window.pageParams||{},scrollModule=function(){function a(a){if(f)return!1;var c=k+"&page="+a;f=1,loading.show("加载中...",i),$.ajax({url:c,dataType:"json",success:function(a){if(f=0,a&&a.list&&a.list instanceof Array){var c=a.list;b(c||[]),loading.hide()}else loading.error(i);a.page_total===!1&&(l=1,loading.complete("已全部显示"))},failure:function(){f=0}})}function b(a){var b=[];$.each(a,function(a,c){if(!c.message_id)return void(b[a]="");var d="guest-talk";c.isOwner&&(d="me-talk");var e="http://my."+pageParams.siteDomain+"/?app=user&func=getAvatar&pro=uv&user_id="+c.insert_id+"&type=small",f="http://xiaozu."+pageParams.siteDomain+"/home.php?mod=space&uid="+c.insert_id+"&do=profile",g='<li class="clear"><time class="date-talk">'+c.insert_time+'</time><section class="'+d+'"><a class="avatar-talk" href="'+f+'"><img class="avator-round" src="'+e+'"></a><div class="content-talk"><p>'+c.content+'</p></div><span class="username">'+c.insert_name+"</span></section></li>";b[a]=g}),i.append(b.join(""))}function c(){var b=$(window).height(),c=($(document.body).height(),i.outerHeight());$(h).on("scroll",function(){return g&&clearTimeout(g),l||f?!1:(loading.show("上拉加载历史消息"),void(g=setTimeout(function(){var d=h.scrollTop();d+b>=c-60&&(j++,a(j))},500)))})}function d(a){var b=[];$.each(a,function(a,c){if(!c.message_id)return void(b[a]="");var d="guest-talk";c.isOwner&&(d="me-talk");var e="http://my."+pageParams.siteDomain+"/?app=user&func=getAvatar&pro=uv&user_id="+c.insert_id+"&type=small",f="http://xiaozu."+pageParams.siteDomain+"/home.php?mod=space&uid="+c.insert_id+"&do=profile",g='<li class="clear"><time class="date-talk">'+c.insert_time+'</time><section class="'+d+'"><a class="avatar-talk" href="'+f+'"><img class="avator-round" src="'+e+'"></a><div class="content-talk"><p>'+c.content+'</p></div><span class="username">'+c.insert_name+"</span></section></li>";b[a]=g}),i.addClass("talk-list-add"),$(b.join("")).insertBefore(i.children("li:first")),i.removeClass("talk-list-add")}function e(){var a;setInterval(function(){return a?!1:(a=1,void $.ajax({url:pageParams.ajaxUrl.getNewMsg,dataType:"json"}).done(function(a){a&&a.list&&a.list instanceof Array&&d(a.list||[])}).complete(function(){a=0}))},m)}var f,g,h=$("#page-chat"),i=$("#talk-msg-list"),j=1,k=i.attr("data-url"),l=parseInt(i.attr("data-loadend"),10)||0,m=1e4;return{init:function(){i.size()&&(c(),l&&loading.complete("已全部显示"),e())},addNewMsg:d}}(),indexList=function(){function a(){var a,b=$(document.body).height(),c=$(window).height(),e=function(){var a=$(document.body).scrollTop();a+c>=b-60&&!f&&!g&&d(++l)};$(window).on("scroll",function(){a&&clearTimeout(a),a=setTimeout(function(){e()},500)}),c>=b&&e()}function b(){$.ajax({url:n,cache:!1,dataType:"jsonp"}).done(function(a){var b=a.data,c=parseInt(b,10);c=isNaN(c)?0:c,c!=m&&(m=c,l=1,f=0,d(l))})}function c(){var a=1e4;setInterval(function(){b()},a)}function d(a){if(g)return!1;var b=pageParams.ajaxUrl.getMsgList,c=b+(b.indexOf("?")>-1?"&":"&")+"page="+a;g=1,j.html(i.loading),$.ajax({url:c,dataType:"json",success:function(b){if(g=0,b&&b.list&&b.list instanceof Array){var c=b.list;1==a&&k.find("li:not([class])").remove(),e(c||[]),j.html(i.toload)}else j.html(i.toload);b.page_total===!1&&(f=1,j.html(i.loadend))},failure:function(){g=0,a--}})}function e(a){var b=[];$.each(a,function(a,c){if(!c.talk_id)return void(b[a]="");var d=("http://my."+pageParams.siteDomain+"/?app=user&func=getAvatar&pro=uv&user_id="+c.insert_id+"&type=small","http://xiaozu."+pageParams.siteDomain+"/home.php?mod=space&uid="+c.insert_id+"&do=profile",'<li><a href="index.php?func=userTalkList&amp;t='+c.talk_id+'" class="clear"><div class="user-avator fl">');d+=c.userNum>0?'<img class="avator-round" src="http://s1.'+pageParams.siteDomain+'/images/user/qun.jpg">':'<img class="avator-round" src="http://my.'+pageParams.siteDomain+"/?app=user&func=getAvatar&pro=uv&user_id="+c.userId+'&type=small">',d+='</div><dl class="user-info"><dt>'+c.user_name+"</dt><dd>"+(c.noMessage?"":c.last_message)+'</dd></dl><span class="plus"><span class="dateline">'+(!c.noMessage&&c.last_time?c.last_time:"")+"</span>",c.unread>0&&(d+='<i class="bubble bubble-dot-red">'+c.unread+"</i>"),d+="</span></a></li>",b[a]=d}),k.append(b.join(""))}var f,g,h={},i={loadend:"没有更多消息",loading:'<i class="fa-li fa fa-spinner fa-spin"></i><span>加载中…</span>',toload:"下拉加载更多消息"},j=$("#loading-area"),k=$("#index-msg-list"),l=1,m=0,n="http://m.zhitiao."+pageParams.siteDomain+"/index.php?app=message&func=messageTotal";return h.init=function(){k.size()>0&&(a(),c())},h}();$(function(){$(".btn-form-send").on("click",function(){$("form").submit()}),$(".msg-form").on("submit",function(){var a=$(this),b=a.find(".msg-t"),c=a.find(".msg-c");return $.trim(b.val())&&$.trim(c.val())?void 0:!1}),$(".popup-close").on("click",function(){var a=$(this).closest(".wrap-popup");a.hide()});var a=($(".c-item:eq(0)"),$(".tab-item:eq(0)"),$("#pop-userlist"));$("#open-user-list").on("click",function(){a.children("div").css({minHeight:$(window).height()}),a.show()}),$(".tab-menu").on("click",".tab-item",function(){var a=$(this),b=a.closest(".tab-menu"),c=b.next(".tab-content"),d=$($(a).attr("href"));return d.size()&&(c.children(".c-item").hide(),d.show(),b.find(".current").removeClass("current"),a.addClass("current"),a.hasClass("select")||d.load(a.attr("data-url"))),!1});var b=$("#msg-username");$(".user-wrap").on("click",".list-item",function(){var c=$(this).find("dt").text();b.val(c),a.hide(),b.focus()});{var c,d=$("#chat-sendmsg-form"),e=$("#chat-sendmsg-box").find(".txt");$(".sendmsg-go")}d.on("submit",function(){var a=d.attr("action"),b=$.trim(e.val());return!b||c?!1:(c=1,$.ajax({type:"post",url:a,data:{content:b},success:function(a){1==parseInt(a,10)&&window.location.reload(),c=0},error:function(){c=0}}),!1)}),scrollModule.init(),$(".show-menu").on("click",function(){var a=$($(this).attr("data-menu"));return a.size()&&a.show(),!1}),$(".menu-wrap").on("click",function(){var a=$(this);a.hide()});var f='<p>你已屏蔽此人。<a href="javascript:;" class="unblock-user">点击这里</a>解除屏蔽</p>';$(".menu-wrap .block-user").on("click",function(){var a=window.confirm("确认屏蔽？屏蔽后将收不到对方发来的纸条。");if(a){var b=$(this).attr("data-val"),c=util.parseJSON(b),d=pageParams.ajaxUrl.banUser;$.post(d,c).done(function(a){1==parseInt(a,10)&&($(".info-msg").html(f).show(),$(".info-msg").find("a").attr("data-val",b))})}}),$(".menu-wrap .clear-talk").on("click",function(){var a=window.confirm("确认清空？这个对话内容将被全部删除。");if(a){var b=$(this).attr("data-val"),c=util.parseJSON(b),d=pageParams.ajaxUrl.delTalk;$.post(d,c).done(function(a){1==parseInt(a,10)&&window.location.reload()})}}),$(document.body).on("click","a[data-command]",function(){var a,b=$(this),c=b.attr("data-command"),d=$(this).attr("data-val"),e=util.parseJSON(d);"unblockuser"==c&&(a=pageParams.ajaxUrl.unblockUser,$.post(a,e).done(function(a){1==parseInt(a,10)&&$(".info-msg").html("").hide()})),"refresh"==c&&window.location.reload()}),indexList.init()});